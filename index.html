<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <script src="./engine.js"></script>
        <script>
            var eng, camera;
            var rotateSpeed = 0.03, moveSpeed = 1;
            var fps = 60;
            var globalSpeed = 60 / fps;
            var mainLoopInterval;
            var worldWidth = 512;
            var worldHeight = 512;
            function randInt(from, to)
            {
                return Math.floor(Math.random() * (to - from)) + from;
            }
            var keyPresses = {
                left: false,
                right: false,
                up: false,
                down: false
            };
            function mainUpdate()
            {
                //eng.camera.direction += 0.02;
                if(keyPresses.left)
                {
                    camera.direction -= rotateSpeed * globalSpeed;
                }
                if(keyPresses.right)
                {
                    camera.direction += rotateSpeed * globalSpeed;
                }
                if(keyPresses.up)
                {
                    camera.position.x += Math.cos(camera.direction) * moveSpeed * globalSpeed;
                    camera.position.y += Math.sin(camera.direction) * moveSpeed * globalSpeed;
                }
                if(keyPresses.down)
                {
                    camera.position.x -= Math.cos(camera.direction) * moveSpeed * globalSpeed;
                    camera.position.y -= Math.sin(camera.direction) * moveSpeed * globalSpeed;
                }
                rect(eng.ctx, 0, 0, worldWidth, worldHeight, "", "#FFFFFF");
                //eng.drawWorld();
                let visualCamRadius = 4, visualCamDirLength = 16;
                let cx = camera.position.x, cy = camera.position.y, dir = camera.direction;
                rect(eng.ctx, cx - visualCamRadius, cy - visualCamRadius, cx + visualCamRadius, cy + visualCamRadius, "", "#000000");
                line(eng.ctx, cx, cy, cx + (Math.cos(dir) * visualCamDirLength), cy + (Math.sin(dir) * visualCamDirLength), "#0000FF");
                line(eng.ctx, cx, cy, cx + (Math.cos(dir + (camera.fov / 2)) * camera.viewDist), cy + (Math.sin(dir + (camera.fov / 2)) * camera.viewDist), "#0000FF");
                line(eng.ctx, cx, cy, cx + (Math.cos(dir - (camera.fov / 2)) * camera.viewDist), cy + (Math.sin(dir - (camera.fov / 2)) * camera.viewDist), "#0000FF");
                camera.draw(512, 32, { x: 0, y: 480 });
            }
            function startMainLoop()
            {
                mainLoopInterval = window.setInterval(mainUpdate, 1000 / fps);
            }
            function stopMainLoop()
            {
                clearInterval(mainLoopInterval);
            }
            window.addEventListener("load", function() {
                eng = new UDEngine(document.getElementById("container"), worldWidth, worldHeight);
                camera = new UDCamera(eng);
                function setCameraOnClick()
                {
                    var x = parseInt(document.getElementById("xval").value);
                    var y = parseInt(document.getElementById("yval").value);
                    var angle = parseFloat(document.getElementById("angle").value) * ( Math.PI / 180);
                    camera.position = {
                        x: x,
                        y: y
                    };
                    camera.direction = angle;
                }
                document.getElementById("setbutton").addEventListener("click", setCameraOnClick);
                document.getElementById("updatebutton").addEventListener("click", function() {
                    setCameraOnClick();
                });
                document.addEventListener("keydown", function(event) {
                    switch(event.keyCode)
                    {
                        case 37:
                            keyPresses.left = true;
                            break;
                        case 39:
                            keyPresses.right = true;
                            break;
                        case 38:
                            keyPresses.up = true;
                            break;
                        case 40:
                            keyPresses.down = true;
                            break;
                    }
                });
                document.addEventListener("keyup", function(event) {
                    switch(event.keyCode)
                    {
                        case 37:
                            keyPresses.left = false;
                            break;
                        case 39:
                            keyPresses.right = false;
                            break;
                        case 38:
                            keyPresses.up = false;
                            break;
                        case 40:
                            keyPresses.down = false;
                            break;
                    }
                });
                startMainLoop();
                eng.setSize(512, 512);
                /*
                let pointCount = 20;
                for(var i = 0; i < pointCount; i++)
                {
                    console.log((i + 1) + " / " + pointCount);
                    var color = new UDColor(randInt(0, 256), randInt(0, 256), randInt(0, 256));
                    var x = randInt(0, worldWidth), y = randInt(0, worldHeight);
                    var atom = new UDAtom(eng, x, y, color);
                    eng.addItem(atom);
                }*/
                function generateCircle(count, radius, xoff, yoff)
                {
                    for(var i = 0; i < count; i++)
                    {
                        var deg = 2 * Math.PI * (i / count);
                        var x = Math.cos(deg) * radius + xoff;
                        var y = Math.sin(deg) * radius + yoff;
                        var color = new UDColor(360 * i / count, 255, 127);
                        var atom = new UDAtom(eng, x, y, color);
                        atom.filters.push(Filter.BasicLighting.create(atom));
                        eng.addItem(atom);
                    }
                }
                let numCircles = 128;
                for(let i = 0; i < numCircles; i++)
                {
                    let x = randInt(0, worldWidth), y = randInt(0, worldHeight);
                    generateCircle(256, 4, x, y);
                    console.log("circle " + (i + 1) + " / " + numCircles);
                }/*
                for(let i = 0; i < 1024; i++)
                {
                    let atom = new UDAtom(eng, 0, i / 4, new UDColor(0, 255, 127));
                    atom.filters.push(Filter.TestRedirect.create(atom));
                    eng.addItem(atom);
                }*/
            });
        </script>
        <style>
            body {
                margin: auto;
            }
            canvas {
                margin: 10px;
                outline-style: solid;
                outline-color: black;
                outline-width: 1px;
            }
        </style>
    </head>
    <body>
        <div>
            <input type="text" value="0" id="xval">
            <input type="text" value="0" id="yval">
            <input type="text" value="0" id="angle">
            <input type="button" value="set" id="setbutton">
            <input type="button" value="update" id="updatebutton">
        </div>
        <div id="container"></div>
    </body>
</html>