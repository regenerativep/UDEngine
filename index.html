<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <script src="./Heir/heir.js"></script>
        <script src="./EventEmitter/EventEmitter.min.js"></script>
        <script src="./engine.js"></script>
        <script>
            var eng;
            var rotateSpeed = 0.05, moveSpeed = 4;
            var fps = 60;
            var globalSpeed = 60 / fps;
            var mainLoopInterval;
            function randInt(from, to)
            {
                return Math.floor(Math.random() * (to - from)) + from;
            }
            var keyPresses = {
                left: false,
                right: false,
                up: false,
                down: false
            };
            window.addEventListener("load", function() {
                eng = new UDEngine(document.getElementById("container"));
                function setCameraOnClick()
                {
                    var x = parseInt(document.getElementById("xval").value);
                    var y = parseInt(document.getElementById("yval").value);
                    var angle = parseFloat(document.getElementById("angle").value) * ( Math.PI / 180);
                    eng.camera.position = {
                        x: x,
                        y: y
                    };
                    eng.camera.direction = angle;
                }
                document.getElementById("setbutton").addEventListener("click", setCameraOnClick);
                document.getElementById("updatebutton").addEventListener("click", function() {
                    setCameraOnClick();
                    eng.update();
                });
                document.addEventListener("keydown", function(event) {
                    switch(event.keyCode)
                    {
                        case 37:
                            keyPresses.left = true;
                            break;
                        case 39:
                            keyPresses.right = true;
                            break;
                        case 38:
                            keyPresses.up = true;
                            break;
                        case 40:
                            keyPresses.down = true;
                            break;
                    }
                });
                document.addEventListener("keyup", function(event) {
                    switch(event.keyCode)
                    {
                        case 37:
                            keyPresses.left = false;
                            break;
                        case 39:
                            keyPresses.right = false;
                            break;
                        case 38:
                            keyPresses.up = false;
                            break;
                        case 40:
                            keyPresses.down = false;
                            break;
                    }
                });
                mainLoopInterval = window.setInterval(function() {
                    //eng.camera.direction += 0.02;
                    if(keyPresses.left)
                    {
                        eng.camera.direction -= rotateSpeed * globalSpeed;
                    }
                    if(keyPresses.right)
                    {
                        eng.camera.direction += rotateSpeed * globalSpeed;
                    }
                    if(keyPresses.up)
                    {
                        eng.camera.position.x += Math.cos(eng.camera.direction) * moveSpeed * globalSpeed;
                        eng.camera.position.y += Math.sin(eng.camera.direction) * moveSpeed * globalSpeed;
                    }
                    if(keyPresses.down)
                    {
                        eng.camera.position.x -= Math.cos(eng.camera.direction) * moveSpeed * globalSpeed;
                        eng.camera.position.y -= Math.sin(eng.camera.direction) * moveSpeed * globalSpeed;
                    }
                    eng.update();
                }, 1000 / fps);
                var worldWidth = 256;
                var worldHeight = 256;
                eng.setSize(512, 512);
                
                /*for(var i = 0; i < 1024; i++)
                {
                    var color = new UDColor(randInt(0, 256), randInt(0, 256), randInt(0, 256));
                    var x = randInt(0, worldWidth), y = randInt(0, worldHeight);
                    var atom = new UDAtom(eng, x, y, color);
                    eng.tree.addItem(atom);
                }*/
                function generateCircle(count, radius, xoff, yoff)
                {
                    for(var i = 0; i < count; i++)
                    {
                        var deg = 2 * Math.PI * (i / count);
                        var x = Math.cos(deg) * radius + xoff;
                        var y = Math.sin(deg) * radius + yoff;
                        var color = new UDColor(360 * i / count, 255, 127);
                        console.log(color.hue);
                        var atom = new UDAtom(eng, x, y, color);
                        eng.tree.addItem(atom);
                    }
                }
                for(let i = 0; i < 8; i++)
                {
                    let x = randInt(0, worldWidth), y = randInt(0, worldHeight);
                    generateCircle(256, 32, x, y);
                }
                for(let i = 0; i < 1024; i++)
                {
                    let atom = new UDAtom(eng, 0, i / 4, new UDColor(0, 255, 127));
                    atom.filters.push(Filter.TestRedirect.create(atom));
                    eng.tree.addItem(atom);
                }
                eng.tree.split();
                eng.update();
            });
        </script>
        <style>
            body {
                margin: auto;
            }
            canvas {
                margin: 10px;
                outline-style: solid;
                outline-color: black;
                outline-width: 1px;
            }
        </style>
    </head>
    <body>
        <div>
            <input type="text" value="0" id="xval">
            <input type="text" value="0" id="yval">
            <input type="text" value="0" id="angle">
            <input type="button" value="set" id="setbutton">
            <input type="button" value="update" id="updatebutton">
        </div>
        <div id="container"></div>
    </body>
</html>